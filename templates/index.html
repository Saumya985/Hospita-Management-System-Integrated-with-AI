<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .table-container { overflow-x: auto; white-space: nowrap; }
        .quick-actions { display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; background: #f9f9f9; border-radius: 5px; }
        .btn-quick { flex: 1; padding: 5px; background: #e0e0e0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-quick:hover { background: #d0d0d0; }
        
        /* New Styles for OCR Box */
        .ocr-box {
            background: #e8f5e9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 2px dashed #4caf50;
            text-align: center;
        }
        .ocr-btn {
            background: #2e7d32; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 4px;
            font-weight: bold;
            margin-top: 10px;
        }
        .ocr-btn:hover { background: #1b5e20; }
    </style>
</head>
<body>

<div class="header">
    <h1>HOSPITAL MANAGEMENT SYSTEM (AI INTEGRATED)</h1>
</div>

<div class="container">
    <div class="form-container">
        
        <div class="ocr-box">
            <h3 style="margin-top: 0; color: #2e7d32;">üì∏ Smart Scan (AI Vision)</h3>
            <p style="font-size: 14px; color: #555;">Upload a prescription image to auto-fill Patient Name & Medicine.</p>
            <input type="file" id="ocrFile" accept="image/*">
            <br>
            <button type="button" onclick="scanPrescription()" class="ocr-btn">
                Scan & Auto-Fill
            </button>
            <div id="ocrStatus" style="margin-top: 10px; font-weight: bold; font-size: 13px; color: #333;"></div>
        </div>
        <form id="patientForm" action="/add" method="POST">
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2; background: #e3f2fd; padding: 5px;">
                    <label style="color: #0d47a1;">üë®‚Äç‚öïÔ∏è Assign Doctor</label>
                    <select name="doctor" id="doctor">
                        <option value="">-- Select Doctor --</option>
                        {% for doc in doctors %}
                        <option value="{{ doc }}">{{ doc }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Name of Tablets</label>
                    <select name="name" id="name">
                        <option>Nice</option>
                        <option>Corona Vaccine</option>
                        <option>Acetaminophen</option>
                        <option>Adderall</option>
                        <option>Amlodipine</option>
                        <option>Ativan</option>
                    </select>
                </div>
                <div class="form-group"><label>Reference No</label><input type="text" name="ref" id="ref" required></div>
                
                <div class="form-group">
                    <label>Disease / Condition</label>
                    <input type="text" name="disease" id="disease" placeholder="e.g. Flu, Infection">
                </div>

                <div class="form-group"><label>Dose</label><input type="text" name="dose" id="dose"></div>
                <div class="form-group"><label>No of Tablets</label><input type="text" name="no_of_tablets" id="no_of_tablets"></div>
                <div class="form-group"><label>Lot</label><input type="text" name="lot" id="lot"></div>
                <div class="form-group"><label>Issue Date</label><input type="date" name="issue_date" id="issue_date"></div>
                <div class="form-group"><label>Exp Date</label><input type="date" name="exp_date" id="exp_date"></div>
                <div class="form-group"><label>Daily Dose</label><input type="text" name="daily_dose" id="daily_dose"></div>

                <div class="form-group"><label>Storage Advice</label><input type="text" name="storage" id="storage"></div>
                <div class="form-group"><label>NHS Number</label><input type="text" name="nhs" id="nhs"></div>
                <div class="form-group"><label>Patient Name</label><input type="text" name="pname" id="pname"></div>
                <div class="form-group"><label>Date of Birth</label><input type="text" name="dob" id="dob"></div>
                <div class="form-group"><label>Address</label><input type="text" name="address" id="address"></div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-add">Add Prescription</button>
                <button type="submit" formaction="/update" class="btn btn-update">Update</button>
                <button type="button" onclick="deleteRecord()" class="btn btn-delete">Delete</button>
                <button type="reset" class="btn btn-clear">Clear</button>
            </div>
        </form>
    </div>

    <div class="bottom-section">
        <div class="chat-box">
            <h3>Interactive Patient Chatbot</h3>
            <div id="chat-history" class="chat-history">
                <div class="bot-msg">Hello! Select a patient row to enable quick buttons.</div>
            </div>
            
            <div class="quick-actions">
                <button onclick="triggerQuickAction('show')" class="btn-quick">Show Full Details</button>
                <button onclick="triggerQuickAction('recommend')" class="btn-quick">Health Advice</button>
                <button onclick="triggerQuickAction('supply')" class="btn-quick">Check Supply</button>
            </div>

            <div class="chat-input">
                <input type="text" id="user-input" placeholder="Type here...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Assigned Doctor</th>
                        <th>Ref No</th>
                        <th>Patient Name</th>
                        <th>Disease</th> <th>Tablet</th>
                        <th>Dose</th>
                        <th>No of Tabs</th>
                        <th>Issue Date</th>
                        <th>Exp Date</th>
                        <th>Daily Dose</th>
                        <th>Storage</th>
                        <th>NHS Number</th>
                        <th>DOB</th>
                        <th>Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in patients %}
                    <tr onclick='fillForm({{ p|tojson }})'>
                        <td style="font-weight:bold; color:blue;">{{ p.doctor }}</td>
                        <td>{{ p.Reference_No }}</td>
                        <td>{{ p.patientname }}</td>
                        <td>{{ p.Disease }}</td> <td>{{ p.Nameoftablets }}</td>
                        <td>{{ p.dose }}</td>
                        <td>{{ p.Numbersoftablets }}</td>
                        <td>{{ p.issuedate }}</td>
                        <td>{{ p.expdate }}</td>
                        <td>{{ p.dailydose }}</td>
                        <td>{{ p.storage }}</td>
                        <td>{{ p.nhsnumber }}</td>
                        <td>{{ p.DOB }}</td>
                        <td>{{ p.patientaddress }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentRef = "";

    function fillForm(data) {
        document.getElementById('name').value = data.Nameoftablets || "";
        document.getElementById('ref').value = data.Reference_No || "";
        document.getElementById('dose').value = data.dose || "";
        document.getElementById('no_of_tablets').value = data.Numbersoftablets || "";
        document.getElementById('lot').value = data.lot || "";
        document.getElementById('issue_date').value = data.issuedate || "";
        document.getElementById('exp_date').value = data.expdate || "";
        document.getElementById('daily_dose').value = data.dailydose || "";
        document.getElementById('storage').value = data.storage || "";
        document.getElementById('nhs').value = data.nhsnumber || "";
        document.getElementById('pname').value = data.patientname || "";
        document.getElementById('dob').value = data.DOB || "";
        document.getElementById('address').value = data.patientaddress || "";
        document.getElementById('doctor').value = data.doctor || "";
        
        // NEW: Fill Disease Field
        document.getElementById('disease').value = data.Disease || "";
        
        currentRef = data.Reference_No;
    }

    function deleteRecord() {
        const ref = document.getElementById('ref').value;
        if(ref && confirm("Are you sure you want to delete " + ref + "?")) {
            window.location.href = "/delete/" + ref;
        }
    }

    // --- NEW: OCR FUNCTION ---
    function scanPrescription() {
        const fileInput = document.getElementById('ocrFile');
        const status = document.getElementById('ocrStatus');
        const file = fileInput.files[0];

        if (!file) {
            alert("Please select an image first.");
            return;
        }

        status.innerHTML = "‚è≥ Scanning image... please wait...";
        status.style.color = "blue";

        const formData = new FormData();
        formData.append('file', file);

        fetch('/scan_prescription', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                status.innerHTML = "‚ùå Error: " + data.error;
                status.style.color = "red";
            } else {
                status.innerHTML = "‚úÖ Scan Complete! Auto-fill successful.";
                status.style.color = "green";
                
                // Auto-fill Patient Name
                if(data.pname) {
                    document.getElementById('pname').value = data.pname;
                }
                
                // Auto-fill Medicine (Dropdown)
                if(data.name) {
                    document.getElementById('name').value = data.name;
                }

                alert(`Scanning Result:\n\nExtracted Name: ${data.pname}\nExtracted Tablet: ${data.name}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            status.innerHTML = "‚ùå Connection Failed.";
            status.style.color = "red";
        });
    }
    // -------------------------

    function triggerQuickAction(actionType) {
        const inputField = document.getElementById('user-input');
        if (currentRef) {
            if (actionType === 'show') inputField.value = "show " + currentRef;
            if (actionType === 'recommend') inputField.value = "recommend " + currentRef;
            if (actionType === 'supply') inputField.value = "supply " + currentRef;
            sendMessage();
        } else {
            alert("Please select a patient row from the table first!");
        }
    }

    function sendMessage() {
        const input = document.getElementById('user-input');
        const history = document.getElementById('chat-history');
        const text = input.value;
        if(!text) return;

        history.innerHTML += `<div class="user-msg">You: ${text}</div>`;
        input.value = "";
        history.scrollTop = history.scrollHeight;

        fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text, context_ref: currentRef})
        })
        .then(response => response.json())
        .then(data => {
            history.innerHTML += `<div class="bot-msg">Bot: ${data.response}</div>`;
            history.scrollTop = history.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            history.innerHTML += `<div class="bot-msg" style="color:red">Error: Connection failed.</div>`;
        });
    }
</script>

</body>
</html>