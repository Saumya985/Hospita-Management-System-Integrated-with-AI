<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* INLINE CSS FOR OCR & LAYOUT FIXES */
        .table-container { 
            overflow-x: auto; 
            white-space: nowrap; 
        }
        
        .ocr-box {
            background: #e8f5e9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 2px dashed #4caf50;
            text-align: center;
        }

        .ocr-btn {
            background: #2e7d32; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 4px;
            font-weight: bold;
            margin-top: 10px;
        }
        .ocr-btn:hover { background: #1b5e20; }
        
        .btn-quick { 
            flex: 1; 
            padding: 6px; 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 11px; 
            color: #555;
            transition: background 0.2s;
        }
        .btn-quick:hover { background: #e0e0e0; color: #000; }
    </style>
</head>
<body>

<div class="header">
    <h1>HOSPITAL MANAGEMENT SYSTEM (AI INTEGRATED)</h1>
</div>

<div class="container">
    <div class="form-container">
        <div class="ocr-box">
            <h3 style="margin-top: 0; color: #2e7d32;">üì∏ Smart Scan (AI Vision)</h3>
            <p style="font-size: 14px; color: #555;">Upload a prescription image to auto-fill Patient Name & Medicine.</p>
            <input type="file" id="ocrFile" accept="image/*">
            <br>
            <button type="button" onclick="scanPrescription()" class="ocr-btn">
                Scan & Auto-Fill
            </button>
            <div id="ocrStatus" style="margin-top: 10px; font-weight: bold; font-size: 13px; color: #333;"></div>
        </div>

        <form id="patientForm" action="/add" method="POST">
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2; background: #e3f2fd; padding: 10px; border-radius: 5px;">
                    <label style="color: #0d47a1; font-weight: bold;">üë®‚Äç‚öïÔ∏è Assign Doctor</label>
                    <select name="doctor" id="doctor">
                        <option value="">-- Select Doctor --</option>
                        {% for doc in doctors %}
                        <option value="{{ doc }}">{{ doc }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Name of Tablets</label>
                    <select name="name" id="name">
                        <option value="Nice">Nice</option>
                        <option value="Corona Vaccine">Corona Vaccine</option>
                        <option value="Acetaminophen">Acetaminophen</option>
                        <option value="Adderall">Adderall</option>
                        <option value="Amlodipine">Amlodipine</option>
                        <option value="Ativan">Ativan</option>
                        <option value="Paracetamol">Paracetamol</option>
                        <option value="Dollo">Dollo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Reference No</label>
                    <input type="text" name="ref" id="ref" required placeholder="Enter Ref ID">
                </div>
                
                <div class="form-group">
                    <label>Disease / Condition</label>
                    <input type="text" name="disease" id="disease" placeholder="e.g. Flu, Infection">
                </div>

                <div class="form-group">
                    <label>Dose</label>
                    <input type="text" name="dose" id="dose" placeholder="e.g. 500mg">
                </div>

                <div class="form-group">
                    <label>No of Tablets</label>
                    <input type="text" name="no_of_tablets" id="no_of_tablets" placeholder="Total Qty">
                </div>

                <div class="form-group">
                    <label>Lot</label>
                    <input type="text" name="lot" id="lot" placeholder="Batch No">
                </div>

                <div class="form-group">
                    <label>Issue Date</label>
                    <input type="date" name="issue_date" id="issue_date">
                </div>

                <div class="form-group">
                    <label>Exp Date</label>
                    <input type="date" name="exp_date" id="exp_date">
                </div>

                <div class="form-group">
                    <label>Daily Dose</label>
                    <input type="text" name="daily_dose" id="daily_dose" placeholder="Doses per day">
                </div>

                <div class="form-group">
                    <label>Storage Advice</label>
                    <input type="text" name="storage" id="storage" placeholder="e.g. cool place">
                </div>

                <div class="form-group">
                    <label>NHS Number</label>
                    <input type="text" name="nhs" id="nhs" placeholder="NHS ID">
                </div>

                <div class="form-group">
                    <label>Patient Name</label>
                    <input type="text" name="pname" id="pname" placeholder="Full Name">
                </div>

                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="text" name="dob" id="dob" placeholder="DD-MM-YYYY">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label>Address</label>
                    <input type="text" name="address" id="address" placeholder="Residential Address">
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-add">Add Prescription</button>
                <button type="submit" formaction="/update" class="btn btn-update">Update Record</button>
                <button type="button" onclick="deleteRecord()" class="btn btn-delete">Delete Patient</button>
                <button type="reset" class="btn btn-clear">Clear Form</button>
            </div>
        </form>
    </div>

    <div class="bottom-section">
        <div class="table-container" style="width: 100%; height: 500px; border: 1px solid #ddd; background: white;">
            <table>
                <thead>
                    <tr>
                        <th>Assigned Doctor</th>
                        <th>Ref No</th>
                        <th>Patient Name</th>
                        <th>Disease</th> 
                        <th>Tablet</th>
                        <th>Dose</th>
                        <th>No of Tabs</th>
                        <th>Issue Date</th>
                        <th>Exp Date</th>
                        <th>Daily Dose</th>
                        <th>Storage</th>
                        <th>NHS Number</th>
                        <th>DOB</th>
                        <th>Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in patients %}
                    <tr onclick='fillForm({{ p|tojson }})' style="cursor: pointer;">
                        <td style="font-weight:bold; color:blue;">{{ p.doctor }}</td>
                        <td>{{ p.Reference_No }}</td>
                        <td>{{ p.patientname }}</td>
                        <td>{{ p.Disease }}</td> 
                        <td>{{ p.Nameoftablets }}</td>
                        <td>{{ p.dose }}</td>
                        <td>{{ p.Numbersoftablets }}</td>
                        <td>{{ p.issuedate }}</td>
                        <td>{{ p.expdate }}</td>
                        <td>{{ p.dailydose }}</td>
                        <td>{{ p.storage }}</td>
                        <td>{{ p.nhsnumber }}</td>
                        <td>{{ p.DOB }}</td>
                        <td>{{ p.patientaddress }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="robot-icon" onclick="toggleChat()">
    <img src="{{ url_for('static', filename='robo.webp') }}" alt="AI Help">
</div>

<div id="chat-popup" class="chat-box" style="display: none;">
    <div class="chat-header" style="background: #0d47a1; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: bold;">ü§ñ AI Health Assistant</span>
        <button onclick="toggleChat()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚úñ</button>
    </div>
    
    <div id="chat-history" class="chat-history" style="height: 320px; overflow-y: auto; padding: 10px; background: #f9f9f9;">
        <div class="bot-msg" style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">
            Hello! I am your AI assistant. Click a patient row or type a Ref No (e.g., 666) to start.
        </div>
    </div>
    
    <div class="quick-actions" style="padding: 8px; background: #eeeeee; display: flex; gap: 8px; border-top: 1px solid #ddd;">
        <button onclick="triggerQuickAction('show')" class="btn-quick">Details</button>
        <button onclick="triggerQuickAction('recommend')" class="btn-quick">Advice</button>
        <button onclick="triggerQuickAction('supply')" class="btn-quick">Supply</button>
    </div>

    <div class="chat-input" style="padding: 10px; border-top: 1px solid #ccc; display: flex; gap: 8px; background: white;">
        <input type="text" id="user-input" placeholder="Ask about dosage, supply, or health..." style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
        <button onclick="sendMessage()" style="padding: 8px 15px; background: #0d47a1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Send</button>
    </div>
</div>

<script>
    let currentRef = "";

    // ‚å®Ô∏è Event Listener for 'Enter' Key
    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    // üìã Fill form when clicking a table row
    function fillForm(data) {
        document.getElementById('name').value = data.Nameoftablets || "";
        document.getElementById('ref').value = data.Reference_No || "";
        document.getElementById('dose').value = data.dose || "";
        document.getElementById('no_of_tablets').value = data.Numbersoftablets || "";
        document.getElementById('lot').value = data.lot || "";
        document.getElementById('issue_date').value = data.issuedate || "";
        document.getElementById('exp_date').value = data.expdate || "";
        document.getElementById('daily_dose').value = data.dailydose || "";
        document.getElementById('storage').value = data.storage || "";
        document.getElementById('nhs').value = data.nhsnumber || "";
        document.getElementById('pname').value = data.patientname || "";
        document.getElementById('dob').value = data.DOB || "";
        document.getElementById('address').value = data.patientaddress || "";
        document.getElementById('doctor').value = data.doctor || "";
        document.getElementById('disease').value = data.Disease || "";
        
        currentRef = data.Reference_No;
        console.log("Current Reference set to:", currentRef);
    }

    function deleteRecord() {
        const ref = document.getElementById('ref').value;
        if(ref && confirm("‚ö†Ô∏è Are you sure you want to delete record: " + ref + "?")) {
            window.location.href = "/delete/" + ref;
        }
    }

    // üì∏ Tesseract OCR Logic
    function scanPrescription() {
        const fileInput = document.getElementById('ocrFile');
        const status = document.getElementById('ocrStatus');
        const file = fileInput.files[0];

        if (!file) {
            alert("Please select an image file first.");
            return;
        }

        status.innerHTML = "‚è≥ Processing image with AI Vision...";
        status.style.color = "blue";

        const formData = new FormData();
        formData.append('file', file);

        fetch('/scan_prescription', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                status.innerHTML = "‚ùå OCR Error: " + data.error;
                status.style.color = "red";
            } else {
                status.innerHTML = "‚úÖ AI Scan Complete!";
                status.style.color = "green";
                
                if(data.pname) document.getElementById('pname').value = data.pname;
                if(data.name) document.getElementById('name').value = data.name;

                alert("AI Extracted Details:\nPatient: " + (data.pname || "Not Found") + "\nTablet: " + (data.name || "Not Found"));
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            status.innerHTML = "‚ùå Connection Failed.";
        });
    }

    function toggleChat() {
        const chatBox = document.getElementById('chat-popup');
        chatBox.style.display = (chatBox.style.display === "none") ? "flex" : "none";
    }

    function triggerQuickAction(actionType) {
        const inputField = document.getElementById('user-input');
        if (currentRef) {
            inputField.value = actionType + " " + currentRef;
            sendMessage();
        } else {
            alert("‚ùå Please select a patient row from the table first!");
        }
    }

    // üí¨ Chat and Context Syncing
    function sendMessage() {
        const input = document.getElementById('user-input');
        const history = document.getElementById('chat-history');
        const text = input.value;
        
        if(!text.trim()) return;

        history.innerHTML += `<div class="user-msg" style="text-align:right; color:#0d47a1; margin:10px 0; font-size:13px;"><b>You:</b> ${text}</div>`;
        input.value = "";
        history.scrollTop = history.scrollHeight;

        fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text, context_ref: currentRef})
        })
        .then(response => response.json())
        .then(data => {
            history.innerHTML += `<div class="bot-msg" style="text-align:left; color:#2e7d32; margin:10px 0; font-size:13px; border-left: 3px solid #2e7d32; padding-left: 5px;"><b>Bot:</b> ${data.response}</div>`;
            
            // Sync currentRef if Backend found a new patient via text
            if (data.ref) {
                currentRef = data.ref;
                console.log("Context Synced to Ref:", currentRef);
            }
            
            history.scrollTop = history.scrollHeight;
        })
        .catch(error => {
            console.error('Chat Error:', error);
            history.innerHTML += `<div class="bot-msg" style="color:red">Error: AI Connection lost.</div>`;
        });
    }
</script>

</body>
</html>